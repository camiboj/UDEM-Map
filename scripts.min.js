function resetBindings(a){const b=a;$(".toggle").off("click").on("click",function(){let[,a]=$(this).attr("id").split("-");if(b.network.isCluster("cluster-"+a)){b.network.openCluster("cluster-"+a);let c=b.network.groups.groups[a].color;$(this).css("background-color",c)}else b.network.cluster({joinCondition:function(b){return b.categoria===a},clusterNodeProperties:{id:"cluster-"+a,hidden:!0,level:20,allowSingleNodeCluster:!0}}),$(this).css("background-color","");b.network.fit()}),b.network.off("click").on("click",function(a){if(a.event.isFinal){let c=a.nodes[0];return c?void(b.materias.get(c).aprobada&&-1!=b.materias.get(c).nota?(b.desaprobar(c),$(".close-button").click()):(b.aprobar(c,0,b.cuatri),$(".close-button").click(),b.materias.get(c).mostrarOpciones()),b.chequearNodosCRED()):void $(".close-button").click()}})}function breakWords(a){let b="";return a.split(" ").forEach(a=>{b+=5>a.length?" "+a:"\n"+a}),b.trim()}function materiasAprobadasConNota(a,b){let c=new Map,d=-1;return a.forEach((a,e)=>{e>b||a.forEach((a,b)=>{0>=a||(c.has(b)?e>d&&(c.set(b,a),d=e):c.set(b,a))})}),c}function materiasAprobadas(a,b){let c=[];return a.forEach((a,d)=>{d>b||a.forEach((a,b)=>{-1==a||c.includes(b)||c.push(b)})}),c}function crearNetwork(a,b){return new vis.Network($("#grafo")[0],{nodes:a,edges:b},{nodes:{shape:"box"},layout:{hierarchical:{enabled:!0,direction:"LR",levelSeparation:150}},edges:{arrows:{to:{enabled:!0,scaleFactor:.7,type:"arrow"}}},groups:{Aprobadas:{color:"#1dd1a1"},CBC:{color:"#ff9f43"},Habilitadas:{color:"#ff9f43"},"En Final":{color:"#feca57"},"Materias Obligatorias":{color:"#54a0ff"},"Materias Electivas":{color:"#a29bfe"},"Orientación: Gestión Industrial de Sistemas":{color:"#fab1a0"},"Orientación: Sistemas Distribuidos":{color:"#C4E538"},"Orientación: Sistemas de Producción":{color:"#fd79a8"},"Orientación: Diseño Mecánico":{color:"#fab1a0"},"Orientación: Termomecánica":{color:"#C4E538"},"Orientación: Metalúrgica":{color:"#fd79a8"},"Orientación: Computación Aplicada":{color:"#BDC581"},"Orientación: Industrias":{color:"#EE5A24"},"Orientación: Multiples Orientaciones":{color:"#fab1a0"},"Orientación: Procesamiento de Señales":{color:"#C4E538"},"Orientación: Automatización y Control":{color:"#fd79a8"},"Orientación: Física Electrónica":{color:"#BDC581"},"Orientación: Telecomunicaciones":{color:"#EE5A24"},"Orientación: Sistemas Digitales y Computación":{color:"#FFE4E1"},"Orientación: Multimedia":{color:"#FFDAB9"},"Orientación: Instrumentación Biomédica":{color:"#66CDAA"}}})}function notificationSnackbar(a){$("#footer-snackbar-center").html($(`
        <div id="notification">
            <p class="close-button" onclick="$(this.parentElement.parentElement).empty();"><i class="fas fa-fw fa-times"></i></p> 
            <p><strong>Datos guardados!</strong> Ya podés entrar a <a href=https://camiboj.github.io/UdeMM-Map/?clave=`+a+`>https://camiboj.github.io/UdeMM-Map/?clave=`+a+`</a> y ver tu progreso.</p>
        </div>
    `))}function warningSnackbar(a){$("#footer-snackbar-center").html($(`
        <div id="alert">
            <p class="close-button" onclick="$(this.parentElement.parentElement).empty();"><i class="fas fa-fw fa-times"></i></p> 
            <p><strong>Padrón no registrado!</strong> Seleccioná tu carrera, marca las materias que aprobaste y toca el boton de guardar.
            <br>
            Una vez guardado, podés entrar a <a href=https://camiboj.github.io/UdeMM-Map/?clave=`+a+`>https://camiboj.github.io/UdeMM-Map/?clave=`+a+`</a> y ver tu progreso.</p>
        </div>
    `))}function defaultFooterSnackbar(){$("#footer-snackbar-left").html($("\n    <div>\n        <a target=\"_blank\" href=\"https://github.com/camiboj/UdeMM-Map\"><i class=\"fab fa-fw fa-github\"></i></a> \n        <a><i onclick=\"$('#mail-content').toggle()\" class=\"fas fa-fw fa-envelope\"></i><span id=\"mail-content\"> fdelmazo at fi.uba.ar</span></a> \n    </div>\n    "))}function setCuatri(a){FIUBAMAP.cuatri=a,$("#cuatri input").val(a.toString().replace(".","c").replace(",","c"))}function getCuatri(){return parseFloat($("#cuatri input").val().replace("c","."))}function cuatriActual(){return date=new Date,anio=date.getYear()+1900,mes=date.getMonth(),cuatri=6>=mes?1:2,parseFloat(anio+"."+cuatri)}function getPrev(a){let b=10*(a-Math.floor(a)).toFixed(1);return 1==b?parseFloat((a-.9).toFixed(1)):parseFloat((a-.1).toFixed(1))}function getNext(a){let b=10*(a-Math.floor(a)).toFixed(1);return 1==b?parseFloat((a+.1).toFixed(1)):parseFloat((a+.9).toFixed(1))}$(document).ready(function(){$(document).on("keyup",function(a){37===a.keyCode&&(setCuatri(getPrev(getCuatri())),FIUBAMAP.cambiarCuatri()),39==a.keyCode&&(setCuatri(getNext(getCuatri())),FIUBAMAP.cambiarCuatri())}),$("#cuatri-next").on("click",function(){setCuatri(getNext(getCuatri())),FIUBAMAP.cambiarCuatri()}),$("#cuatri-prev").on("click",function(){setCuatri(getPrev(getCuatri())),FIUBAMAP.cambiarCuatri()})});let FORMAPI="https://docs.google.com/forms/d/1IFRP4ifmtypiXjf-DkUYHcn3OIJ8SyhgrIdnI7DbRyc",SHEETAPI="https://spreadsheets.google.com/feeds/list/1el8-pMpIodMIPwMLzNwJAI0hnIQ9nT01GNScb_RDMII/default/public/values?alt=json";function save(a,b,c){let d=$("<form id='formRecord' type='hidden' action=https://docs.google.com/forms/d/1IFRP4ifmtypiXjf-DkUYHcn3OIJ8SyhgrIdnI7DbRyc onsubmit='return window.submitGoogleForm(this)'></form>");d.append("<input name='entry.2130926747' value="+a+">"),d.append("<input name='entry.240287082' value="+b+">"),d.append("<input name='entry.1203898638' value="+c+">"),d.submit()}function loadMap(a,b){$("#clave input").val(b);let c=a.feed.entry,d=null;if(c.forEach(a=>{a.gsx$clave.$t==b&&(d=a)}),!d)return warningSnackbar(b),void $("#sistemas").click();let e=d.gsx$carrera.$t,f=d.gsx$materias.$t;main(e),cargarMaterias(f)}$(document).ready(function(){$("#clave-save").on("click",function(){let a=$("#clave input").val();if(!a)return;let b=FIUBAMAP.carrera,c=mapToJson(FIUBAMAP.aprobadas);save(a,b,c);let d=new URL(window.location.href);d.searchParams.set("clave",a),window.history.pushState("","",d.toString()),notificationSnackbar(a)}),$("#clave-load").on("click",function(){let a=$("#clave input").val();a&&(window.location="https://camiboj.github.io/UdeMM-Map/?clave="+a)}),$("#clave input").on("keyup",function(a){13===a.keyCode&&(a.preventDefault(),$("#clave-load").click())})});function cargarMaterias(a){let b=objToMap(a);FIUBAMAP.aprobadas=b,FIUBAMAP.cambiarCuatri()}function mapToJson(a){let b={};return a.forEach((a,c)=>{b[c]=Object.fromEntries(a)}),JSON.stringify(b)}function objToMap(a){let b=JSON.parse(a),c=new Map;return Object.keys(b).forEach(a=>{let d=new Map;Object.keys(b[a]).forEach(c=>{d.set(c,parseInt(b[a][c]))}),c.set(parseFloat(a),d)}),c}FIUBAMAP=null;class FiubaMap{constructor(a,b){FIUBAMAP=this,this.init(a),this.carrera=b,this.creditos=0,this.cuatri=cuatriActual(),setCuatri(this.cuatri),this.aprobadas=new Map,resetBindings(this),this.actualizarCreditos(),this.actualizarPromedio()}aprobar(a,b,c,d){this.desaprobar(a,d);let e=this.materias.get(a);e.aprobar(b),this.agregarMateria(e,c),this.actualizar()}desaprobar(a,b){let c=this.materias.get(a);b||this.removerMateria(c),c.desaprobar(),this.actualizar()}cambiarCuatri(){const a=this;a.aprobadas.forEach((b,c)=>{c=parseFloat(c),c>a.cuatri?b.forEach((b,c)=>{-1==a.materias.get(c).nota&&-1!=b||a.desaprobar(c,!0)}):b.forEach((b,d)=>{a.aprobar(d,b,c,!0)})}),this.actualizar(),this.chequearNodosCRED()}actualizar(){this.actualizarPromedio(),this.actualizarCreditos()}actualizarPromedio(){const a=this;let b=0,c=0,d=materiasAprobadasConNota(a.aprobadas,a.cuatri);d.forEach(a=>{b+=a,c++});let e=(b/c).toFixed(2);isNaN(e)?$("#promedio").empty():($("#promedio").text("Promedio: "+e),$("#promedio").show())}actualizarCreditos(){const a=this;let b=0,c=materiasAprobadas(a.aprobadas,a.cuatri);c.forEach(a=>{let c=this.materias.get(a);b+=c.creditos});let d=100*(b/48);$("#creditos-var").text(d.toFixed(2)+"%"),a.creditos=b}chequearNodosCRED(){this.materias_cred.forEach(a=>{this.creditos<a.requiere?a.deshabilitar():this.creditos>=a.requiere&&a.habilitar()})}agregarMateria(a,b){let c=this.aprobadas.get(b);c||(c=new Map),c.set(a.id,a.nota),this.aprobadas.set(parseFloat(b),c)}removerMateria(a){this.aprobadas.forEach((b,c)=>{b.delete(a.id),b.size||this.aprobadas.delete(c)})}init(a){let b=[],c=new Map,d=[],e=[],f=[],g=a.split(/\r?\n|\r/);for(let h=1;h<g.length;h++){if(!g[h])continue;let[a,i,j,k,l,m]=g[h].split(","),o=new Materia(a,i,j,l,m);k.split("-").forEach(a=>{if(a.includes("CRED")){let[,b]=a.split("CRED");o.requiere=b,f.push(o)}let b={from:a,to:o.id};"CBC"==a&&o.requiere&&(b.hidden=!0),d.push(b)}),o.setTitle(),b.push(o),c.set(a,o),e.includes(o.categoria)||e.push(o.categoria)}this.materias=c,this.materias_cred=f,this.nodos=new vis.DataSet(b),this.network=crearNetwork(this.nodos,new vis.DataSet(d));let h=`<a class='toggle' id='toggle-Materias Electivas'>Electivas</a>`;if(this.network.cluster({joinCondition:function(a){return"Materias Electivas"===a.categoria},clusterNodeProperties:{id:"cluster-Materias Electivas",hidden:!0,level:20,allowSingleNodeCluster:!0}}),e=e.filter(a=>a.includes("Orientaci\xF3n")),0==e.length)$("#materias").append(h);else{$("#materias").append(`
            <a class="dropbtn">
                <span>Materias</span>
                <i class="fas fa-fw fa-caret-down"></i>
            </a>
            <div id='materias-dropdown' class="dropdown-content dropdown-content-right">`+h+`</div>`),e.forEach(a=>{this.network.cluster({joinCondition:function(b){return b.categoria===a},clusterNodeProperties:{id:"cluster-"+a,hidden:!0,level:20,allowSingleNodeCluster:!0}});let[,b]=a.split(":");$("#materias-dropdown").append("<a class='toggle' id='toggle-"+a+"'>"+b+"</a>")})}}}!function(a){a.submitGoogleForm=function(a){try{const b=[].slice.call(a).map(function(a){return"value"in a&&a.name?a.name+"="+(void 0===a.value?"":a.value):""}).join("&"),c=new XMLHttpRequest;c.open("POST",a.action+"/formResponse",!0),c.setRequestHeader("Accept","application/xml, text/xml, */*; q=0.01"),c.setRequestHeader("Content-type","application/x-www-form-urlencoded; charset=UTF-8"),c.send(b)}catch(a){}return a.parentNode.className+=" submitted",!1}}("undefined"==typeof module?window:module.exports);function main(a){$("#grafo").html("<div class='loader'></div>"),defaultFooterSnackbar(),$("#carreras .dropdown-content").hide(),$("#carreras .active").removeClass("active"),$("#materias").empty();let b,c,d,e;"psicologia"===a?(b="data/psicologia-UDEM.csv",e="Plan",c="Psicolog\xEDa",d="Psicolog\xEDa"):void 0;$("#carrera-actual-long").text(c+" | "+e),$("#carrera-actual-short").text(d),$("#"+a).addClass("active"),$.ajax({url:b,dataType:"text",success:function(b){new FiubaMap(b,a)},async:!1})}$(document).ready(function(){$(".dropdown").on("mouseover",function(){$(this).children(".dropdown-content").show()}),$(".dropdown").on("mouseout",function(){$(this).children(".dropdown-content").hide()}),$(".carrera").on("click",function(){main($(this).attr("id")),FIUBAMAP.aprobar("CBC",0,FIUBAMAP.cuatri)}),$(document).keydown(function(a){27==a.keyCode&&$(".close-button").click()})}),$(document).ready(function(){$("#grafo").html("<div class='loader'></div>"),defaultFooterSnackbar();let a=new URL(window.location.href),b=a.searchParams.get("clave");b?$.ajax({url:SHEETAPI,method:"GET",success:function(a){loadMap(a,b)}}):$("#psicologia").click()});class Materia{constructor(a,b,c,d,e){this.id=a,this.label=breakWords(b),this.creditos=parseInt(c),this.group=d,this.level=e,this.categoria=d,this.aprobada=!1,this.nota=0,this.habilitada=!1}aprobar(a){if(this.aprobada=!0,this.nota=parseInt(a),this.label.includes("[")&&(this.label=this.label.split("\n[")[0]),-1==a)return this.label+="\n[Final]",void this.actualizar();0<a&&(this.label+="\n["+this.nota+"]");let b=FIUBAMAP.network.getConnectedNodes(this.id,"to");b.forEach(a=>{let b=FIUBAMAP.materias.get(a);b&&b.habilitar()}),this.actualizar()}habilitar(){let a=FIUBAMAP.network.getConnectedNodes(this.id,"from"),b=!0;for(let c,d=0;d<a.length;d++)c=FIUBAMAP.materias.get(a[d]),c&&(b&=c.aprobada);!b||FIUBAMAP.creditos<this.requiere||(this.habilitada=!0,this.actualizar())}desaprobar(){this.aprobada=!1,this.nota=0,this.label.includes("[")&&(this.label=this.label.split("\n[")[0]);let a=FIUBAMAP.network.getConnectedNodes(this.id,"to");a.forEach(a=>{let b=FIUBAMAP.materias.get(a);b&&b.deshabilitar()}),this.actualizar()}deshabilitar(){this.habilitada=!1,this.actualizar()}actualizar(){let a=this.categoria;this.aprobada&&0<=this.nota?a="Aprobadas":this.aprobada?a="En Final":this.habilitada&&(a="Habilitadas"),this.group=a,FIUBAMAP.nodos.update(this),FIUBAMAP.actualizar()}setTitle(){this.title="Otorga: "+this.creditos+" cr\xE9ditos",this.requiere&&(this.title+=" -- Requiere: "+this.requiere+" cr\xE9ditos")}mostrarOpciones(){const a=this;let b=a.nota?a.nota:"",c=`
        <div id="materia" class="center">
            <p id="materia-close" class="close-button" onclick="defaultFooterSnackbar();"><i class="fas fa-fw fa-times"></i></p> 
            <small><p><strong>[`+a.id+`] </strong>`+a.label.split("(")[0]+`</p></small>
            <div>
                <input type="number" min="4" max="10" placeholder="Nota" value="`+b+`" />
                <button id='materia-aprobar' style="background-color: `+FIUBAMAP.network.groups.groups.Aprobadas.color+`">Aprobar</button>
            </div>
            <div><button id='materia-enfinal' style="background-color:`+FIUBAMAP.network.groups.groups["En Final"].color+`">Poner En Final</button></div>
        </div>
        `;$("#footer-snackbar-left").html($(c)),$("#materia-aprobar").on("click",function(){let b=$("#materia input").val();4>b||10<b||(!b&&(b=0),FIUBAMAP.aprobar(a.id,b,FIUBAMAP.cuatri),$("#materia-close").click())}),$("#materia-enfinal").on("click",function(){FIUBAMAP.aprobar(a.id,-1,FIUBAMAP.cuatri),$("#materia-close").click()}),$("#materia").on("keyup",function(a){13===a.keyCode&&(a.preventDefault(),$("#materia-aprobar").click())})}}$(document).ready(function(){$("#fullscreen-mode").on("click",function(){$("#header").remove(),$("#footer").remove()}),$("#dark-mode").on("click",function(){$("html").hasClass("dark")?($("html").removeClass("dark"),$("#dark-mode i").removeClass("fa-sun"),$("#dark-mode i").addClass("fa-moon")):($("html").addClass("dark"),$("#dark-mode i").removeClass("fa-moon"),$("#dark-mode i").addClass("fa-sun"))})});